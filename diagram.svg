<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 490"
     font-family="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif">
  <defs>
    <marker id="ah-blue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="#2563eb"/>
    </marker>
    <marker id="ah-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="#16a34a"/>
    </marker>
    <marker id="ah-gray" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto">
      <polygon points="0 0,8 3,0 6" fill="#94a3b8"/>
    </marker>
  </defs>

  <!-- Canvas -->
  <rect width="1100" height="490" fill="white"/>

  <!-- ══════════════════════════════════════════════════════════════════ -->
  <!-- Worker Thread                                                      -->
  <!-- ══════════════════════════════════════════════════════════════════ -->

  <rect x="20" y="60" width="170" height="310" rx="8"
        fill="#dbeafe" stroke="#2563eb" stroke-width="1.5"/>

  <text x="105" y="50" text-anchor="middle" font-size="12" font-weight="600" fill="#1e3a8a">Worker Thread</text>

  <text x="105" y="91" text-anchor="middle" font-size="12" font-weight="700"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#1e40af">StrandWriter</text>
  <line x1="36" y1="103" x2="174" y2="103" stroke="#93c5fd" stroke-width="1"/>

  <text x="105" y="121" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#1d4ed8">begin()</text>
  <text x="105" y="141" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#1d4ed8">writeRecordBatch()</text>
  <text x="105" y="161" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#1d4ed8">finalize()</text>
  <text x="105" y="181" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#1d4ed8">abort()</text>
  <text x="105" y="201" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#1d4ed8">reset()</text>

  <!-- ══════════════════════════════════════════════════════════════════ -->
  <!-- SharedArrayBuffer                                                  -->
  <!-- ══════════════════════════════════════════════════════════════════ -->

  <rect x="260" y="22" width="580" height="390" rx="8"
        fill="#f8fafc" stroke="#475569" stroke-width="1.5"/>
  <text x="550" y="15" text-anchor="middle" font-size="12" font-weight="600" fill="#0f172a">SharedArrayBuffer</text>

  <!-- ── HEADER ─────────────────────────────────────────────────────── -->
  <rect x="278" y="38" width="544" height="128" rx="5"
        fill="#ede9fe" stroke="#7c3aed" stroke-width="1"/>
  <text x="550" y="58" text-anchor="middle" font-size="11.5" font-weight="700" fill="#4c1d95">HEADER · 512 B</text>
  <text x="550" y="76"  text-anchor="middle" font-size="10" fill="#6d28d9">magic · version · schema_fingerprint · CRC</text>
  <text x="550" y="92"  text-anchor="middle" font-size="10" fill="#6d28d9">record_stride · index_capacity · heap_capacity</text>
  <text x="550" y="108" text-anchor="middle" font-size="10" fill="#6d28d9">WRITE_SEQ · COMMIT_SEQ · READ_CURSOR · STATUS</text>
  <text x="550" y="124" text-anchor="middle" font-size="10" fill="#6d28d9">HEAP_WRITE · HEAP_COMMIT · ABORT · schema bytes</text>

  <!-- ── INDEX RING ──────────────────────────────────────────────────── -->
  <rect x="278" y="178" width="544" height="100" rx="5"
        fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
  <text x="550" y="196" text-anchor="middle" font-size="11.5" font-weight="700" fill="#78350f">INDEX RING · index_capacity × record_stride bytes</text>
  <text x="550" y="212" text-anchor="middle" font-size="9.5" font-style="italic" fill="#92400e">slot = seq &amp; (index_capacity − 1)</text>

  <!-- Slot boxes -->
  <rect x="320" y="221" width="68" height="30" rx="3" fill="#fde68a" stroke="#b45309" stroke-width="0.75"/>
  <text x="354" y="241" text-anchor="middle" font-size="9.5" fill="#78350f">s = 0</text>

  <rect x="400" y="221" width="68" height="30" rx="3" fill="#fde68a" stroke="#b45309" stroke-width="0.75"/>
  <text x="434" y="241" text-anchor="middle" font-size="9.5" fill="#78350f">s = 1</text>

  <rect x="480" y="221" width="68" height="30" rx="3" fill="#fde68a" stroke="#b45309" stroke-width="0.75"/>
  <text x="514" y="241" text-anchor="middle" font-size="9.5" fill="#78350f">s = 2</text>

  <text x="573" y="242" text-anchor="middle" font-size="14" fill="#b45309">···</text>

  <rect x="598" y="221" width="68" height="30" rx="3" fill="#fde68a" stroke="#b45309" stroke-width="0.75"/>
  <text x="632" y="241" text-anchor="middle" font-size="9.5" fill="#78350f">s = N−1</text>

  <!-- ── HEAP RING ───────────────────────────────────────────────────── -->
  <rect x="278" y="290" width="544" height="110" rx="5"
        fill="#dcfce7" stroke="#16a34a" stroke-width="1"/>
  <text x="550" y="309" text-anchor="middle" font-size="11.5" font-weight="700" fill="#14532d">HEAP RING · heap_capacity bytes</text>

  <!-- Payload segments -->
  <rect x="295" y="320" width="145" height="38" rx="3" fill="#86efac" stroke="#15803d" stroke-width="0.75"/>
  <text x="367" y="344" text-anchor="middle" font-size="9.5" fill="#14532d">utf-8 payload</text>

  <rect x="450" y="320" width="145" height="38" rx="3" fill="#86efac" stroke="#15803d" stroke-width="0.75"/>
  <text x="522" y="344" text-anchor="middle" font-size="9.5" fill="#14532d">utf-8 payload</text>

  <rect x="605" y="320" width="100" height="38" rx="3" fill="#86efac" stroke="#15803d" stroke-width="0.75"/>
  <text x="655" y="344" text-anchor="middle" font-size="9.5" fill="#14532d">utf-8 payload</text>

  <!-- Skip sentinel -->
  <rect x="715" y="320" width="90" height="38" rx="3" fill="#fef08a" stroke="#ca8a04" stroke-width="0.75"/>
  <text x="760" y="336" text-anchor="middle" font-size="9" font-weight="600" fill="#713f12">0xFFFF</text>
  <text x="760" y="350" text-anchor="middle" font-size="8.5" fill="#92400e">skip · sentinel</text>

  <!-- ══════════════════════════════════════════════════════════════════ -->
  <!-- Main Thread                                                        -->
  <!-- ══════════════════════════════════════════════════════════════════ -->

  <rect x="910" y="60" width="170" height="310" rx="8"
        fill="#fce7f3" stroke="#db2777" stroke-width="1.5"/>
  <text x="995" y="50" text-anchor="middle" font-size="12" font-weight="600" fill="#831843">Main Thread</text>

  <text x="995" y="91" text-anchor="middle" font-size="12" font-weight="700"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#9d174d">StrandView</text>
  <line x1="926" y1="103" x2="1064" y2="103" stroke="#f9a8d4" stroke-width="1"/>

  <text x="995" y="121" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#be185d">allocateCursor()</text>
  <text x="995" y="141" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#be185d">waitForCommit()</text>
  <text x="995" y="161" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#be185d">acknowledgeRead()</text>

  <line x1="926" y1="174" x2="1064" y2="174" stroke="#f9a8d4" stroke-width="1"/>

  <text x="995" y="193" text-anchor="middle" font-size="12" font-weight="700"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#9d174d">RecordCursor</text>
  <line x1="926" y1="205" x2="1064" y2="205" stroke="#f9a8d4" stroke-width="1"/>

  <text x="995" y="223" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#be185d">seek(seq)</text>
  <text x="995" y="237" text-anchor="middle" font-size="9" font-style="italic" fill="#db2777">zero heap allocations</text>
  <text x="995" y="255" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#be185d">getU32(name)</text>
  <text x="995" y="273" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#be185d">getString(name)</text>
  <text x="995" y="291" text-anchor="middle" font-size="11"
        font-family="'SF Mono','Fira Code','Consolas','Courier New',monospace"
        fill="#be185d">getRef(name)</text>
  <text x="995" y="311" text-anchor="middle" font-size="10" fill="#be185d">… getI64  getF32  getBool</text>

  <!-- ══════════════════════════════════════════════════════════════════ -->
  <!-- Arrows                                                             -->
  <!-- ══════════════════════════════════════════════════════════════════ -->

  <!-- Write path: Worker → SAB (enters at Index Ring level) -->
  <line x1="190" y1="228" x2="256" y2="228"
        stroke="#2563eb" stroke-width="2" marker-end="url(#ah-blue)"/>
  <text x="223" y="212" text-anchor="middle" font-size="9" fill="#2563eb">Atomics.add(WRITE_SEQ)</text>
  <text x="223" y="224" text-anchor="middle" font-size="9" fill="#2563eb">Atomics.store(COMMIT_SEQ)</text>

  <!-- Read path: SAB → Main (exits at Index Ring level) -->
  <line x1="840" y1="228" x2="906" y2="228"
        stroke="#16a34a" stroke-width="2" marker-end="url(#ah-green)"/>
  <text x="873" y="212" text-anchor="middle" font-size="9" fill="#16a34a">Atomics.load(COMMIT_SEQ)</text>
  <text x="873" y="224" text-anchor="middle" font-size="9" fill="#16a34a">Atomics.waitAsync()</text>

  <!-- Backpressure: Main → Worker (via acknowledgeRead) -->
  <path d="M 995 370 L 995 452 L 105 452 L 105 370"
        fill="none" stroke="#94a3b8" stroke-width="1.5"
        stroke-dasharray="5,3" marker-end="url(#ah-gray)"/>
  <text x="550" y="471" text-anchor="middle" font-size="9" fill="#64748b">
    acknowledgeRead()  →  Atomics.notify(READ_CURSOR)  →  unblocks stalled producer
  </text>
</svg>
